{% extends 'base.html' %}
{% load static %}

{% block title %}Twitter – Feed{% endblock %}

{% block extra_css %}
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
  <link rel="icon" href="{% static 'img/twitter.png' %}" type="image/png">
  <link rel="stylesheet" href="{% static 'css/feed.css' %}">
{% endblock %}

{% block content %}
<div class="container">

  <h1>Bem-vindo, {{ username }}!</h1>

  <!-- Formulário de nova postagem -->
  <form method="POST" class="post-form" action="{% url 'postar' %}">
    {% csrf_token %}
    {{ form.conteudo }}

    {% include 'includes/erros.html' with form_obj=form %}

    <button type="submit">Postar</button>
  </form>

  <!-- Listagem de postagens -->
  {% for item in postagens_info %}
    <div class="post">
      <p><strong>{{ item.post.autor.username }}</strong>: {{ item.post.conteudo }}</p>
      <small>{{ item.post.data_criacao }}</small>

      <p>{{ item.total_curtidas }} curtida{{ item.total_curtidas|pluralize }}</p>

      <!-- Botão Curtir/Descurtir -->
      <form method="POST" action="{% url 'curtir' item.post.id %}">
        {% csrf_token %}
        {% if item.curtido %}
          <button type="submit">Descurtir</button>
        {% else %}
          <button type="submit">Curtir</button>
        {% endif %}
      </form>

      <!-- Comentários da postagem -->
      <div class="comentarios">
        <h4>Comentários</h4>
        {% for comentario in item.post.comentarios.all %}
          <p>
            <strong>{{ comentario.autor.username }}</strong>:
            {{ comentario.texto }}
            <br>
            <small>{{ comentario.data_criacao }}</small>
          </p>
        {% empty %}
          <p><em>Seja o primeiro a comentar!</em></p>
        {% endfor %}
      </div>

      <!-- Formulário de novo comentário -->
      <form method="POST" action="{% url 'comentar' %}">
        {% csrf_token %}
        {{ comentario_form.texto }}

        {% include 'includes/erros.html' with form_obj=comentario_form %}

        <input type="hidden" name="post_id" value="{{ item.post.id }}">
        <button type="submit">Comentar</button>
      </form>
    </div>
  {% empty %}
    <p>Você ainda não segue ninguém ou não há postagens.</p>
  {% endfor %}

  <!-- Botões adicionais -->
  <div class="actions">
    <form method="POST" action="{% url 'logoff' %}">
      {% csrf_token %}
      <button type="submit">Sair</button>
    </form>

    <form method="POST" action="{% url 'excluir_conta' %}">
      {% csrf_token %}
      <button type="submit">Excluir Conta</button>
    </form>
  </div>

</div>
{% endblock %}

{% block extra_js %}
  <script src="{% static 'js/erros.js' %}"></script>
{% endblock %}